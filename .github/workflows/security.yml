name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security checks daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (high severity - fail on high)
        run: npm audit --audit-level=high

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Check for hardcoded secrets (custom patterns)
        run: |
          echo "Checking for hardcoded secrets..."

          # Check for hardcoded passwords
          if grep -r "password.*=.*['\"][^'\"]\{8,\}['\"]" --include="*.ts" --include="*.tsx" src/ 2>/dev/null | grep -v "test" | grep -v "\.test\."; then
            echo "WARNING: Potential hardcoded password found"
          fi

          # Check for hardcoded API keys (common patterns)
          if grep -rE "(api[_-]?key|apikey|secret[_-]?key)\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]" --include="*.ts" --include="*.tsx" src/ 2>/dev/null | grep -v "test" | grep -v "process\.env"; then
            echo "WARNING: Potential hardcoded API key found"
          fi

          # Check for the known hardcoded password
          if grep -r "hromada!2026" --include="*.ts" --include="*.tsx" src/ 2>/dev/null; then
            echo "ERROR: Hardcoded site password found - must be moved to environment variable"
            exit 1
          fi

          echo "Secret scan complete"

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security tests
        run: npm test -- --testPathPattern=security --coverage
        env:
          NODE_ENV: test
          HROMADA_ADMIN_SECRET: test-secret-for-ci
          SESSION_SECRET: test-session-secret-for-ci-minimum-32-chars

      - name: Upload security test coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: security
          fail_ci_if_error: false

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check security header configuration
        run: |
          echo "Verifying security header configuration..."

          # Check that security headers are defined
          if ! grep -q "X-Frame-Options" src/lib/security.ts; then
            echo "ERROR: X-Frame-Options header not configured"
            exit 1
          fi

          if ! grep -q "X-Content-Type-Options" src/lib/security.ts; then
            echo "ERROR: X-Content-Type-Options header not configured"
            exit 1
          fi

          if ! grep -q "Content-Security-Policy" src/lib/security.ts; then
            echo "ERROR: Content-Security-Policy header not configured"
            exit 1
          fi

          if ! grep -q "Strict-Transport-Security" src/lib/security.ts; then
            echo "ERROR: HSTS header not configured"
            exit 1
          fi

          echo "All required security headers are configured"

  owasp-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'hromada'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: >
            --enableRetired
            --enableExperimental
            --scan package-lock.json

      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports
          retention-days: 30

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, security-tests, security-headers-check]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Security scan complete"
          echo "====================="
          echo "Dependency Audit: ${{ needs.dependency-audit.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Security Headers: ${{ needs.security-headers-check.result }}"

          if [[ "${{ needs.dependency-audit.result }}" == "failure" ]] ||
             [[ "${{ needs.secret-scanning.result }}" == "failure" ]] ||
             [[ "${{ needs.security-tests.result }}" == "failure" ]] ||
             [[ "${{ needs.security-headers-check.result }}" == "failure" ]]; then
            echo ""
            echo "One or more security checks failed. Please review the logs above."
            exit 1
          fi

          echo ""
          echo "All security checks passed!"
