generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id                   String              @id @default(cuid())
  municipalityName     String
  facilityName         String
  category             Category
  briefDescription     String              @db.VarChar(150)
  fullDescription      String              @db.VarChar(2000)
  contactName          String
  contactEmail         String
  cityLatitude         Float
  cityLongitude        Float
  address              String?
  contactPhone         String?
  urgency              Urgency             @default(MEDIUM)
  status               Status              @default(OPEN)
  projectType          ProjectType?
  projectSubtype       String?
  technicalPowerKw     Decimal?            @db.Decimal(10, 2)
  numberOfPanels       Int?
  estimatedCostUsd     Decimal?            @db.Decimal(12, 2)
  cofinancingAvailable CofinancingStatus?
  cofinancingDetails   String?
  partnerOrganization  String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  region               String?
  briefDescriptionUk   String?             @db.VarChar(200)
  facilityNameUk       String?
  fullDescriptionUk    String?             @db.VarChar(3000)
  municipalityNameUk   String?
  // Prozorro procurement tracking
  edrpou               String?           // 8-digit municipality EDRPOU
  prozorroTenderId     String?           // e.g. "UA-2026-03-15-000581-a"
  prozorroTenderUuid   String?           // Prozorro internal UUID (for API calls)
  prozorroStatus       String?           // Last known Prozorro status
  prozorroLastSync     DateTime?         // Last time we polled this tender

  contactSubmissions   ContactSubmission[]
  photos               ProjectImage[]
  documents            ProjectDocument[]
  featuredSlot         FeaturedProject?
  updates              ProjectUpdate[]

  @@index([category])
  @@index([status])
  @@index([urgency])
  @@index([projectType])
  @@index([createdAt])
}

/// Project images with a maximum of 5 per project.
/// The 5-image limit must be enforced at the application layer.
model ProjectImage {
  id        String   @id @default(cuid())
  projectId String
  url       String
  altText   String?  @db.VarChar(200)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sortOrder])
}

/// Contact submissions from donors interested in projects.
/// Email notifications are sent to ADMIN_EMAIL when submissions are created.
model ContactSubmission {
  id         String   @id @default(cuid())
  projectId  String
  donorName  String
  donorEmail String
  message    String   @db.VarChar(1000)
  handled    Boolean  @default(false)
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@index([handled])
}

/// Project submissions from municipalities awaiting admin review.
/// Once approved, a Project record is created from the submission data.
model ProjectSubmission {
  id                   String           @id @default(cuid())
  municipalityName     String
  municipalityEmail    String
  region               String?
  facilityName         String
  category             Category
  projectType          String
  briefDescription     String           @db.VarChar(150)
  fullDescription      String           @db.VarChar(2000)
  urgency              Urgency          @default(MEDIUM)
  estimatedCostUsd     Decimal?         @db.Decimal(12, 2)
  technicalPowerKw     Decimal?         @db.Decimal(10, 2)
  numberOfPanels       Int?
  cofinancingAvailable String?
  cofinancingDetails   String?
  cityName             String
  address              String?
  cityLatitude         Decimal          @db.Decimal(10, 8)
  cityLongitude        Decimal          @db.Decimal(11, 8)
  contactName          String
  contactEmail         String
  contactPhone         String?
  partnerOrganization  String?
  projectSubtype       String?
  additionalNotes      String?          @db.VarChar(1000)
  edrpou               String?          // 8-digit municipality EDRPOU
  status               SubmissionStatus @default(PENDING)
  reviewedAt           DateTime?
  reviewedBy           String?
  rejectionReason      String?
  approvedProjectId    String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  photos               String[]         @default([])
  submittedByUserId    String?
  submittedByUser      User?            @relation(fields: [submittedByUserId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([municipalityEmail])
  @@index([submittedByUserId])
}

enum Category {
  HOSPITAL
  SCHOOL
  WATER
  ENERGY
  OTHER
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Status {
  OPEN
  IN_DISCUSSION
  MATCHED
  FULFILLED
}

enum ProjectType {
  SOLAR_PV
  HEAT_PUMP
  WATER_TREATMENT
  GENERAL
}

enum CofinancingStatus {
  YES
  NO
  NEEDS_CLARIFICATION
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  ADMIN
  PARTNER
  NONPROFIT_MANAGER
  DONOR
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  name                String
  organization        String?
  role                UserRole  @default(PARTNER)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Security fields
  isActive            Boolean   @default(true)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  sessionVersion      Int       @default(1)  // Increment to invalidate all sessions
  lastLoginAt         DateTime?
  lastLoginIp         String?
  passwordChangedAt   DateTime  @default(now())

  projectSubmissions  ProjectSubmission[]
  auditLogs           AuditLog[]
  donations           Donation[]
  passwordResetTokens PasswordResetToken[]
  projectUpdates      ProjectUpdate[]

  @@index([email])
  @@index([role])
  @@index([isActive])
}

/// OTP codes for password reset, expires after 15 minutes
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  code      String    // 6-digit numeric OTP
  expiresAt DateTime  // 15 minutes from creation
  usedAt    DateTime? // null until redeemed
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Security audit log for tracking important events
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, PASSWORD_CHANGE, etc.
  ipAddress String?
  userAgent String?
  details   String?  @db.VarChar(1000)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

/// Donation records - tracks contributions from donors
model Donation {
  id                 String         @id @default(cuid())

  // Project this donation is for (optional - can be general fund)
  projectId          String?
  projectName        String         // Stored for reference even if project is deleted

  // Donor information
  donorUserId        String?        // Link to User if donor has an account
  donorName          String
  donorEmail         String
  donorOrganization  String?

  // Payment details
  amount             Decimal?       @db.Decimal(12, 2)
  paymentMethod      PaymentMethod
  referenceNumber    String?        // Wire reference, DAF grant ID, check number

  // Status tracking
  status             DonationStatus @default(PENDING_CONFIRMATION)

  // Timestamps
  submittedAt        DateTime       @default(now())  // When donor said they sent it
  receivedAt         DateTime?                        // When we confirmed receipt
  allocatedAt        DateTime?                        // When allocated to wire transfer

  // Tax receipt
  taxReceiptUrl      String?        // Storage path to generated PDF in tax-receipts bucket
  forwardedAt        DateTime?      // When wire was sent to Ukraine

  // Wire transfer link
  wireTransferId     String?

  // Notes
  donorMessage       String?        @db.VarChar(1000)
  internalNotes      String?        @db.VarChar(1000)

  // Timestamps
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  donorUser          User?          @relation(fields: [donorUserId], references: [id])
  wireTransfer       WireTransfer?  @relation(fields: [wireTransferId], references: [id])
  updates            DonationUpdate[]

  @@index([projectId])
  @@index([donorUserId])
  @@index([donorEmail])
  @@index([status])
  @@index([createdAt])
  @@index([wireTransferId])
}

enum PaymentMethod {
  WIRE
  DAF
  CHECK
  ACH
  OTHER
}

enum DonationStatus {
  PENDING_CONFIRMATION  // Donor said they sent, awaiting bank confirmation
  RECEIVED              // Confirmed received in CSBE account
  ALLOCATED             // Assigned to a wire transfer batch
  FORWARDED             // Wire transfer sent to Ukraine
  COMPLETED             // Confirmed received by municipality
  FAILED                // Payment failed or bounced
  REFUNDED              // Refund issued
}

/// Updates/notes on a donation for donor visibility
model DonationUpdate {
  id          String   @id @default(cuid())
  donationId  String
  title       String   @db.VarChar(200)
  message     String   @db.VarChar(2000)
  isPublic    Boolean  @default(true)  // If true, visible to donor
  createdAt   DateTime @default(now())
  createdById String?

  donation    Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@index([donationId])
  @@index([createdAt])
}

/// Wire transfer records - tracks outbound transfers to Ukraine
model WireTransfer {
  id                  String             @id @default(cuid())
  referenceNumber     String             @unique

  // Recipient (Ukrainian municipality)
  recipientName       String
  recipientBankName   String?
  recipientBankSwift  String?
  recipientAccountIban String?

  // Amount
  amountUsd           Decimal            @db.Decimal(12, 2)

  // Status
  status              WireTransferStatus @default(PENDING)

  // Project reference (optional)
  projectId           String?
  projectName         String?

  // Tracking
  initiatedById       String?

  // Documentation
  proofDocumentUrl    String?
  internalNotes       String?            @db.VarChar(2000)

  // Timestamps
  initiatedAt         DateTime?
  sentAt              DateTime?
  confirmedAt         DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  donations           Donation[]

  @@index([status])
  @@index([createdAt])
}

enum WireTransferStatus {
  PENDING      // Created, awaiting initiation
  INITIATED    // Wire request submitted to bank
  SENT         // Confirmed sent by Bank of America
  IN_TRANSIT   // In transit to Ukraine
  CONFIRMED    // Confirmed received by recipient
  FAILED       // Transfer failed
  CANCELLED    // Cancelled before sending
}

/// Partnership inquiries from US communities interested in the Municipal Partnership Program.
model PartnershipInquiry {
  id              String   @id @default(cuid())
  communityName   String
  contactName     String
  contactEmail    String
  communityType   String
  approximateSize String?
  message         String?  @db.VarChar(2000)
  handled         Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([handled])
}

model NewsletterSubscriber {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String?
  source           String?  // "website", "calendly", "admin"
  subscribedAt     DateTime @default(now())
  unsubscribed     Boolean  @default(false)
  unsubscribeToken String   @unique @default(cuid())

  @@index([subscribedAt])
}

// ── Email Campaign System ──────────────────────────────────────────

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  CANCELLED
}

/// Newsletter campaigns sent to subscribers
model EmailCampaign {
  id          String         @id @default(cuid())
  subject     String         @db.VarChar(255)
  htmlContent String         @db.Text
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?

  // Audience targeting (null = all active subscribers)
  audienceFilter Json?       // e.g. { "subscribedBefore": "2026-01-01" }

  // Send stats
  totalRecipients Int        @default(0)
  sentCount       Int        @default(0)
  failedCount     Int        @default(0)

  sentAt      DateTime?
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  sends       EmailSend[]

  @@index([status])
  @@index([createdAt])
}

enum EmailSendStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  COMPLAINED
  FAILED
}

/// Per-recipient tracking for campaign sends
model EmailSend {
  id          String          @id @default(cuid())
  campaignId  String
  recipientEmail String
  status      EmailSendStatus @default(QUEUED)
  sesMessageId String?
  errorMessage String?        @db.VarChar(500)
  sentAt      DateTime?
  createdAt   DateTime        @default(now())

  campaign    EmailCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([recipientEmail])
  @@index([status])
}

// ── Drip Sequence System ───────────────────────────────────────────

enum DripTrigger {
  NEW_DONOR
  NEW_SUBSCRIBER
  DONATION_COMPLETED
  INACTIVE_30
  INACTIVE_90
}

/// Automated email sequences triggered by user actions
model DripSequence {
  id        String      @id @default(cuid())
  name      String      @db.VarChar(255)
  trigger   DripTrigger
  active    Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  steps       DripStep[]
  enrollments DripEnrollment[]

  @@index([trigger])
  @@index([active])
}

/// Individual steps within a drip sequence
model DripStep {
  id         String       @id @default(cuid())
  sequenceId String
  stepOrder  Int          // 1, 2, 3...
  delayDays  Int          // Days after enrollment (or previous step)
  subject    String       @db.VarChar(255)
  htmlContent String      @db.Text
  createdAt  DateTime     @default(now())

  sequence   DripSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

/// Tracks a user's progress through a drip sequence
model DripEnrollment {
  id           String           @id @default(cuid())
  sequenceId   String
  email        String
  currentStep  Int              @default(0) // 0 = enrolled but no steps sent yet
  status       EnrollmentStatus @default(ACTIVE)
  nextSendAt   DateTime?
  enrolledAt   DateTime         @default(now())
  completedAt  DateTime?
  cancelledAt  DateTime?

  sequence     DripSequence     @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, email])
  @@index([status, nextSendAt])
  @@index([email])
}

enum DocumentType {
  COST_ESTIMATE
  ENGINEERING_ASSESSMENT
  ITEMIZED_BUDGET
  SITE_SURVEY
  OTHER
}

/// Partner-provided documents (cost estimates, engineering assessments, etc.)
/// Uploaded as PDFs; text is extracted and translated for donor transparency.
model ProjectDocument {
  id               String       @id @default(cuid())
  projectId        String
  url              String       // Supabase storage URL for original PDF
  filename         String       // Original filename for display
  documentType     DocumentType @default(OTHER)
  label            String?      @db.VarChar(100)
  labelUk          String?      @db.VarChar(150)
  originalTextUk   String?      @db.Text
  translatedTextEn String?      @db.Text
  extractionStatus String       @default("pending") // pending, extracted, translated, failed
  fileSize         Int?         // Size in bytes
  createdAt        DateTime     @default(now())
  project          Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

enum ProjectUpdateType {
  PROZORRO_STATUS
  PHOTO_ADDED
  MANUAL
}

/// Project-level activity feed (procurement updates, photo additions, manual notes).
/// Distinct from DonationUpdate, which is scoped to individual donations.
model ProjectUpdate {
  id            String            @id @default(cuid())
  projectId     String
  type          ProjectUpdateType
  title         String            @db.VarChar(200)
  message       String            @db.VarChar(2000)
  metadata      Json?             // Prozorro-specific data (tender URL, old/new status, etc.)
  isPublic      Boolean           @default(true)
  createdAt     DateTime          @default(now())
  createdById   String?
  createdByName String?           @db.VarChar(100) // "Thomas", "EcoAction"
  createdByRole String?           @db.VarChar(30)  // "Admin", "Partner"
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy     User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([createdAt])
}

model FeaturedProject {
  id        String   @id @default(cuid())
  projectId String   @unique
  slot      Int      @unique
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([slot])
}

/// Append-only financial transaction audit trail.
/// Every donation/wire status change, creation, and financial event is recorded here.
/// Designed for fiscal sponsor compliance and future Plaid/Wise webhook data.
model TransactionEvent {
  id              String   @id @default(cuid())

  // What changed
  transactionType String   // DONATION or WIRE_TRANSFER
  transactionId   String   // ID of the Donation or WireTransfer
  action          String   // CREATED, STATUS_CHANGED, AMOUNT_UPDATED, NOTE_ADDED, etc.

  // State transition
  previousStatus  String?  // null on creation
  newStatus       String?  // null if not a status change

  // Financial context
  amount          Decimal? @db.Decimal(12, 2)
  currency        String   @default("USD") @db.VarChar(3)
  paymentMethod   String?
  referenceNumber String?  // wire ref, check number, DAF grant ID

  // Who did it
  actorId         String?  // User ID (null for system/webhook actions)
  actorRole       String?  // ADMIN, NONPROFIT_MANAGER, DONOR, SYSTEM
  ipAddress       String?

  // Additional context
  metadata        Json?    // Flexible field for Plaid/Wise webhook data, notes, etc.

  createdAt       DateTime @default(now())

  @@index([transactionType, transactionId])
  @@index([action])
  @@index([actorId])
  @@index([createdAt])
}

// ── Cron Job State ──────────────────────────────────────────────────

/// Key-value state for cron jobs (e.g. last poll timestamp)
model CronState {
  id        String   @id // e.g. "calendly-sync"
  value     String   // JSON string
  updatedAt DateTime @updatedAt
}
