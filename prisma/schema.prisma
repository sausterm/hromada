generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id                   String              @id @default(cuid())
  municipalityName     String
  facilityName         String
  category             Category
  briefDescription     String              @db.VarChar(150)
  fullDescription      String              @db.VarChar(2000)
  contactName          String
  contactEmail         String
  cityLatitude         Float
  cityLongitude        Float
  address              String?
  contactPhone         String?
  urgency              Urgency             @default(MEDIUM)
  status               Status              @default(OPEN)
  projectType          ProjectType?
  projectSubtype       String?
  technicalPowerKw     Decimal?            @db.Decimal(10, 2)
  numberOfPanels       Int?
  estimatedCostUsd     Decimal?            @db.Decimal(12, 2)
  cofinancingAvailable CofinancingStatus?
  cofinancingDetails   String?
  partnerOrganization  String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  region               String?
  briefDescriptionUk   String?             @db.VarChar(200)
  facilityNameUk       String?
  fullDescriptionUk    String?             @db.VarChar(3000)
  municipalityNameUk   String?
  contactSubmissions   ContactSubmission[]
  photos               ProjectImage[]

  @@index([category])
  @@index([status])
  @@index([urgency])
  @@index([projectType])
  @@index([createdAt])
}

/// Project images with a maximum of 5 per project.
/// The 5-image limit must be enforced at the application layer.
model ProjectImage {
  id        String   @id @default(cuid())
  projectId String
  url       String
  altText   String?  @db.VarChar(200)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sortOrder])
}

/// Contact submissions from donors interested in projects.
/// Email notifications are sent to ADMIN_EMAIL when submissions are created.
model ContactSubmission {
  id         String   @id @default(cuid())
  projectId  String
  donorName  String
  donorEmail String
  message    String   @db.VarChar(1000)
  handled    Boolean  @default(false)
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@index([handled])
}

/// Project submissions from municipalities awaiting admin review.
/// Once approved, a Project record is created from the submission data.
model ProjectSubmission {
  id                   String           @id @default(cuid())
  municipalityName     String
  municipalityEmail    String
  region               String?
  facilityName         String
  category             Category
  projectType          String
  briefDescription     String           @db.VarChar(150)
  fullDescription      String           @db.VarChar(2000)
  urgency              Urgency          @default(MEDIUM)
  estimatedCostUsd     Decimal?         @db.Decimal(12, 2)
  technicalPowerKw     Decimal?         @db.Decimal(10, 2)
  numberOfPanels       Int?
  cofinancingAvailable String?
  cofinancingDetails   String?
  cityName             String
  address              String?
  cityLatitude         Decimal          @db.Decimal(10, 8)
  cityLongitude        Decimal          @db.Decimal(11, 8)
  contactName          String
  contactEmail         String
  contactPhone         String?
  partnerOrganization  String?
  projectSubtype       String?
  additionalNotes      String?          @db.VarChar(1000)
  status               SubmissionStatus @default(PENDING)
  reviewedAt           DateTime?
  reviewedBy           String?
  rejectionReason      String?
  approvedProjectId    String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  photos               String[]         @default([])
  submittedByUserId    String?
  submittedByUser      User?            @relation(fields: [submittedByUserId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([municipalityEmail])
  @@index([submittedByUserId])
}

enum Category {
  HOSPITAL
  SCHOOL
  WATER
  ENERGY
  OTHER
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Status {
  OPEN
  IN_DISCUSSION
  MATCHED
  FULFILLED
}

enum ProjectType {
  SOLAR_PV
  HEAT_PUMP
  WATER_TREATMENT
  GENERAL
}

enum CofinancingStatus {
  YES
  NO
  NEEDS_CLARIFICATION
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  ADMIN
  PARTNER
  NONPROFIT_MANAGER
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  name                String
  organization        String?
  role                UserRole  @default(PARTNER)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Security fields
  isActive            Boolean   @default(true)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  sessionVersion      Int       @default(1)  // Increment to invalidate all sessions
  lastLoginAt         DateTime?
  lastLoginIp         String?
  passwordChangedAt   DateTime  @default(now())

  projectSubmissions ProjectSubmission[]
  auditLogs          AuditLog[]

  @@index([email])
  @@index([role])
  @@index([isActive])
}

/// Security audit log for tracking important events
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, PASSWORD_CHANGE, etc.
  ipAddress String?
  userAgent String?
  details   String?  @db.VarChar(1000)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
